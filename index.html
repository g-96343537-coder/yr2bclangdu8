<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>åƒå¹´ç³• - åœ¨çº¿æœ—è¯»ä½œä¸š</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    :root{ --bg:#fff8ff; --card:#fff; --accent:#ff9fc4; --accent-hover:#ff7eb0; --accent2:#ffd6a5; --text:#333; --muted:#7a6b7a; --shadow: 0 8px 24px rgba(122,107,122,0.12); }
    html,body{height:100%;margin:0;font-family:"PingFang SC","Microsoft YaHei",sans-serif;background:url('https://wallpaperaccess.com/full/1164977.jpg') center/cover no-repeat fixed;color:var(--text)}
    .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:20px;box-sizing: border-box;}
    .card{width:800px; max-width:100%; background:var(--card); border-radius:24px; padding:40px; box-shadow:var(--shadow); display:flex; flex-direction: column; align-items:center; transition: all 0.3s ease;}
    .header-area{text-align:center; margin-bottom: 20px;}
    .avatar{width:80px;height:80px;border-radius:20px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:inline-flex;align-items:center;justify-content:center;font-weight:700;color:#fff;font-size:36px;box-shadow:0 6px 18px rgba(255,159,196,0.3);margin-bottom: 15px;}
    h1{margin:0;font-size:24px;color:#4a3b4a;}
    p.subtitle{margin:8px 0 0;color:var(--muted);font-size:14px;}
    .view-section { display: none; width: 100%; animation: fadeIn 0.5s ease; }
    .view-section.active { display: block; }
    @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
    
    .form-group { margin-bottom: 20px; text-align: left; width: 100%; max-width: 320px; margin: 0 auto 20px auto; }
    label { display: block; margin-bottom: 8px; font-weight: bold; color: var(--muted); }
    select { width: 100%; padding: 12px; border: 2px solid #ffe4ed; border-radius: 12px; font-size: 16px; outline: none; }
    
    /* Google æŒ‰é’®å®¹å™¨ */
    .google-btn-wrapper { width: 100%; display: flex; justify-content: center; margin: 20px 0; min-height: 50px;}

    .user-card {
      display: none; background: #f0fff4; border: 1px solid #c6f6d5; 
      padding: 10px 20px; border-radius: 50px; align-items: center; gap: 10px; margin-bottom: 20px;
    }
    .user-card img { width: 30px; height: 30px; border-radius: 50%; }
    .user-card span { font-weight: bold; color: #276749; font-size: 14px; }

    .btn-large {
      background: linear-gradient(90deg,var(--accent),#ffd6a5); color: #7a2e4a; border: none; padding: 14px 40px;
      font-size: 18px; font-weight: bold; border-radius: 50px; cursor: pointer; box-shadow: 0 6px 16px rgba(255,159,196,0.4);
      transition: transform 0.2s; margin-top: 10px; width: 100%; max-width: 320px;
    }
    .btn-large:disabled { opacity: 0.5; cursor: not-allowed; background: #eee; box-shadow:none; color:#aaa; }

    /* æœ—è¯»é¡µæ ·å¼ - å·²è°ƒæ•´å­—ä½“å¤§å°ä»¥é€‚åº”é•¿å¥ */
    .sentence-box{background:linear-gradient(180deg,#ffffff,#fffaf6);border-radius:16px; padding:30px 20px;display:flex; align-items:center; justify-content:center;min-height:220px; width: 100%; margin: 20px 0;border: 1px solid #fff0f5;}
    /* âš ï¸ å­—ä½“è°ƒæ•´ä¸º 26px ä»¥å®¹çº³æ›´é•¿çš„è¯¾æ–‡ */
    .sentence{font-size:26px;line-height:1.8;text-align:justify; letter-spacing:1px; color: #444; padding: 0 10px;}
    .controls{display:flex;gap:12px;align-items:center;justify-content:center;margin-top:10px; flex-wrap: wrap;}
    .ctrl-btn{padding:10px 20px; border-radius:12px; border:none; cursor:pointer; font-weight:700; font-size: 15px;box-shadow:0 4px 12px rgba(0,0,0,0.05); transition: background 0.2s;}
    .btn-primary{background:var(--accent);color:#fff;}
    .btn-ghost{background:#fff; border:2px solid #ffe4ed; color:var(--accent);}
    .sentence .ch{transition: color 150ms ease, transform 150ms ease; display: inline-block;}
    
    @media (max-width:600px){ 
        .card{padding:24px;} 
        /* ç§»åŠ¨ç«¯å­—ä½“ç›¸åº”ç¼©å° */
        .sentence{font-size:20px; text-align: left;} 
    }
  </style>
</head>
<body>
  <div class="wrap">
    
    <div id="loginView" class="card view-section active">
      <div class="header-area">
        <div class="avatar">ğŸ“–</div>
        <h1>åƒå¹´ç³• - è¯¾æ–‡æœ—è¯»</h1>
        <p class="subtitle">è¯·é€‰æ‹©ç­çº§å¹¶ç™»å½• Google è´¦å·</p>
      </div>

      <div class="form-group">
        <label>é€‰æ‹©ç­çº§ (Class)</label>
        <select id="classSelect">
          <option value="" disabled selected>è¯·ç‚¹å‡»é€‰æ‹©...</option>
          <option value="1M">1M</option>
          <option value="1K">1K</option>
          <option value="1B">1B</option>
          <option value="1H">1H</option>
          <option value="1J">1J</option>
        </select>
      </div>

      <div id="userInfo" class="user-card">
        <img id="userImg" src="" alt="">
        <span id="userNameDisplay"></span>
      </div>

      <div class="google-btn-wrapper" id="googleBtnContainer">
        <div id="g_id_onload"
             data-client_id="1006856013626-uk3eq5tchv9t65gqosb0k6rst7hi1eeb.apps.googleusercontent.com" 
             data-callback="handleCredentialResponse"
             data-auto_prompt="false">
        </div>
        <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="left"></div>
      </div>

      <button id="startAppBtn" class="btn-large" disabled>è¯·å…ˆç™»å½•</button>
      
      <p style="font-size:12px; color:#aaa; margin-top:30px;">Â© åæ–‡è¯¾å®¤</p>
    </div>

    <div id="readingView" class="card view-section">
      <div style="display:flex;gap:15px;align-items:center;width:100%;margin-bottom:10px;">
        <div class="avatar" style="width:60px;height:60px;font-size:28px;margin:0;">è¯»</div>
        <div style="text-align:left;">
          <h1 style="font-size:20px;">æ­£åœ¨æœ—è¯»</h1>
          <p class="subtitle" id="studentInfoDisplay">...</p>
        </div>
      </div>

      <div class="sentence-box"><div class="sentence" id="sentenceText">åŠ è½½ä¸­...</div></div>
      <div class="controls">
        <button id="prevBtn" class="ctrl-btn btn-ghost">â¬… ä¸Šä¸€å¥</button>
        <button id="playBtn" class="ctrl-btn btn-primary">ğŸ”Š æœ—è¯»</button>
        <button id="nextBtn" class="ctrl-btn btn-ghost">ä¸‹ä¸€å¥ â¡</button>
      </div>
      <div class="controls" style="margin-top:15px;">
          <button id="autoBtn" class="ctrl-btn btn-ghost" style="font-size:13px;">è‡ªåŠ¨æ’­æ”¾ï¼šå…³</button>
      </div>
      <div style="margin-top:15px;font-size:13px;color:var(--muted)" id="footerInfo">è¿›åº¦ 1 / 6</div>
    </div>

    <div id="successView" class="card view-section" style="text-align:center;">
      <div style="font-size:60px;margin-bottom:20px">ğŸ‰</div>
      <h1 style="margin-bottom:10px">æ­å–œä½ ï¼</h1>
      <p style="color:var(--muted);margin-bottom:30px">ä½ å·²ç»å®Œæˆäº†ä»Šå¤©çš„æœ—è¯»åŠŸè¯¾ã€‚</p>
      <div style="background:#f0fff4;color:#2e7d32;padding:15px;border-radius:12px;margin-bottom:20px;font-size:14px;">
        âœ… è´¦å·ä¸æˆç»©å·²æäº¤
      </div>
      <button onclick="location.reload()" class="btn-large">å†è¯»ä¸€æ¬¡</button>
    </div>
  </div>

  <script>
    // âš ï¸ æ›¿æ¢è¿™é‡Œä¸ºä½ æ–°å‘å¸ƒçš„ Web App URL
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwYRbe5QGUq_TdKBR0H48jiCr89HTkENzjHN9wTOLbMp39EGl0nUWMPpdqo0xSO_QKnVw/exec";
    
    // âœ… å·²æ›¿æ¢ä¸ºã€Šåƒå¹´ç³•ã€‹çš„è¯¾æ–‡
    const sentences = [
      "æ˜¥èŠ‚æ—¶ï¼Œæˆ‘ä»¬éƒ½å›ä¹¡å‘çˆ·çˆ·å¥¶å¥¶æ‹œå¹´ã€‚",
      "ä¸€å®¶å›¢åœ†æ—¶ï¼Œçˆ·çˆ·å¥¶å¥¶æœ€çˆ±æ‹¿å‡ºç”œç”œçš„å¹´ç³•ç»™æˆ‘ä»¬åƒã€‚",
      "æœ‰ä¸€æ¬¡ï¼Œå¼Ÿå¼Ÿå¥½å¥‡åœ°é—®ï¼šâ€œçˆ·çˆ·ï¼Œä¸ºä»€ä¹ˆæ–°å¹´ä¸€å®šè¦åƒå¹´ç³•ï¼Ÿâ€",
      "çˆ·çˆ·å‘Šè¯‰å¼Ÿå¼Ÿï¼Œå¹´ç³•çš„â€œç³•â€å’Œâ€œé«˜â€åŒéŸ³ï¼Œå¸Œæœ›â€œåƒäº†å¹´ç³•å¹´å¹´é«˜â€ã€‚",
      "åƒäº†å¹´ç³•ï¼Œå°å­©å­é•¿é«˜äº†ï¼Œå¤§äººçš„äº‹ä¸šä¹Ÿæ­¥æ­¥é«˜å‡ï¼Œå¤šæœ‰æ„æ€å•Šï¼",
      "å¼Ÿå¼Ÿå¬äº†ï¼Œå¼€å¿ƒåœ°åƒèµ·å¹´ç³•ï¼Œè¿˜é—®çˆ·çˆ·ï¼šâ€œæ˜¯ä¸æ˜¯å¤šåƒå‡ å£å°±èƒ½å¤Ÿæ›´å¿«é•¿é«˜ï¼Ÿâ€é€—å¾—å¤§å®¶å“ˆå“ˆå¤§ç¬‘ã€‚"
    ];
    
    let currentClass = "";
    let googleUser = null; 
    let index = 0;
    let auto = false;
    let autoTimer = null;

    // Google ç™»å½•å›è°ƒ
    function handleCredentialResponse(response) {
      const responsePayload = decodeJwtResponse(response.credential);
      console.log("ID: " + responsePayload.sub);
      
      googleUser = {
        name: responsePayload.name,
        email: responsePayload.email,
        picture: responsePayload.picture
      };

      document.getElementById('googleBtnContainer').style.display = 'none';
      const userCard = document.getElementById('userInfo');
      userCard.style.display = 'flex';
      document.getElementById('userImg').src = googleUser.picture;
      document.getElementById('userNameDisplay').textContent = googleUser.name;

      checkStartEnable();
    }

    // JWT è§£ç 
    function decodeJwtResponse(token) {
      var base64Url = token.split('.')[1];
      var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    }

    function checkStartEnable() {
      const btn = document.getElementById('startAppBtn');
      if(document.getElementById('classSelect').value && googleUser) {
        btn.disabled = false;
        btn.textContent = "å¼€å§‹åšåŠŸè¯¾ ğŸš€";
      }
    }

    document.getElementById('classSelect').addEventListener('change', (e) => {
      currentClass = e.target.value;
      checkStartEnable();
    });

    document.getElementById('startAppBtn').addEventListener('click', () => {
      document.getElementById('loginView').classList.remove('active');
      document.getElementById('loginView').style.display = 'none';
      const rv = document.getElementById('readingView');
      rv.style.display = 'flex'; rv.classList.add('active');
      
      document.getElementById('studentInfoDisplay').textContent = 
        `ç­çº§: ${currentClass} Â· ${googleUser.name}`;
      loadSentence(0);
    });

    // æœ—è¯»é€»è¾‘
    const sentenceText = document.getElementById('sentenceText');
    function loadSentence(i) {
      if(i >= sentences.length) { finishHomework(); return; }
      if(i < 0) return; // é˜²æ­¢è¶Šç•Œ
      index = i;
      // å°†å¥å­æ‹†åˆ†ä¸ºå­—ç¬¦å¹¶åŒ…è£¹ spanï¼Œæ–¹ä¾¿é€å­—é«˜äº®
      sentenceText.innerHTML = sentences[index].split('').map((ch,idx)=>`<span class="ch" data-i="${idx}">${ch}</span>`).join('');
      document.getElementById('footerInfo').textContent = `è¿›åº¦ ${index+1} / ${sentences.length}`;
    }

    function playCurrent() {
      window.speechSynthesis.cancel();
      document.querySelectorAll('.ch').forEach(el=>el.style.color='');
      
      const msg = new SpeechSynthesisUtterance(sentences[index]);
      msg.lang = 'zh-CN'; 
      msg.rate = 0.9; // è¯­é€Ÿ
      
      // é€å­—é«˜äº®é€»è¾‘
      msg.onboundary = (e) => { 
        if(e.name==='word'||typeof e.charIndex==='number') highlight(e.charIndex); 
      };
      
      // æœ—è¯»ç»“æŸåçš„é€»è¾‘
      msg.onend = () => { 
        if(auto) autoTimer = setTimeout(()=>loadSentence(index+1)||playCurrent(), 2000); // é•¿å¥å­è¯»å®Œå¤šåœé¡¿ä¸€ä¸‹(2ç§’)
      };
      
      window.speechSynthesis.speak(msg);
    }
    
    function highlight(i) {
      document.querySelectorAll('.ch').forEach(el=>el.style.color='');
      // é«˜äº®é€»è¾‘éœ€è¦ç¨å¾®æ¨¡ç³ŠåŒ¹é…ï¼Œå› ä¸ºé•¿å¥å¯èƒ½ä¼šæœ‰æ ‡ç‚¹åç§»
      const span = document.querySelector(`.ch[data-i="${i}"]`);
      if(span) span.style.color='#ff4fa3';
    }

    // æäº¤æ•°æ®
    function finishHomework() {
      auto = false; clearTimeout(autoTimer); window.speechSynthesis.cancel();
      
      const formData = new URLSearchParams();
      formData.append('name', googleUser.name);
      formData.append('email', googleUser.email);
      formData.append('class', currentClass);
      formData.append('score', "å®Œæˆ");
      formData.append('total', sentences.length);

      // å‘é€è¯·æ±‚
      fetch(GAS_URL, {
        method: 'POST', mode: 'no-cors',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: formData
      });

      document.getElementById('readingView').style.display='none';
      const sv = document.getElementById('successView');
      sv.style.display='block'; sv.classList.add('active');
    }

    document.getElementById('playBtn').onclick = playCurrent;
    document.getElementById('nextBtn').onclick = ()=>{ window.speechSynthesis.cancel(); loadSentence(index+1); };
    document.getElementById('prevBtn').onclick = ()=>{ window.speechSynthesis.cancel(); loadSentence(index-1); };
    document.getElementById('autoBtn').onclick = function() {
      auto = !auto; this.textContent = auto?"è‡ªåŠ¨æ’­æ”¾ï¼šå¼€":"è‡ªåŠ¨æ’­æ”¾ï¼šå…³";
      if(auto) playCurrent(); else window.speechSynthesis.cancel();
    };
    
    // åˆå§‹åŒ–ä¸è‡ªåŠ¨åŠ è½½ï¼Œç­‰å¾…ç‚¹å‡»å¼€å§‹
  </script>
</body>
</html>